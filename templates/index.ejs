<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NurdWerks Chess</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <script>
    window.INITIAL_USER = <%- JSON.stringify(user) %>;
  </script>
</head>
<body>
  <div class="container">
    <button id="sidebar-toggle-btn" class="sidebar-toggle" title="Toggle Sidebar">‚ò∞</button>
    <main id="dashboard">
        <div class="panel chessboard-panel">
            <div class="panel-header">
                <h2 class="panel-title">Board</h2>
                <button id="fullscreen-btn" class="icon-btn" title="Fullscreen">‚õ∂</button>
            </div>
            <div class="panel-content">
                <div id="a11y-status" class="sr-only" aria-live="polite"></div>
                <div class="player-info" id="top-player">
                    <img id="top-player-avatar" src="images/avatars/default.png" class="player-avatar" alt="Avatar" onerror="this.style.display='none'">
                    <div class="player-details">
                        <span class="player-name" id="top-player-name">Black</span>
                        <div id="top-material-diff" class="material-diff"></div>
                    </div>
                    <div class="material-bar-container">
                        <div id="top-material-bar" class="material-bar-fill"></div>
                    </div>
                    <div id="top-captured-pieces" class="captured-pieces"></div>
                    <span class="clock" id="top-player-clock">05:00</span>
                </div>
                <div class="board-container">
                    <div id="eval-bar-container">
                        <div id="eval-bar-fill"></div>
                    </div>
                    <div class="board-wrapper">
                        <div id="chessboard"></div>
                        <svg id="arrow-layer" viewBox="0 0 100 100"></svg>
                    </div>
                </div>
                <div class="player-info" id="bottom-player">
                    <img id="bottom-player-avatar" src="images/avatars/default.png" class="player-avatar" alt="Avatar" onerror="this.style.display='none'">
                    <div class="player-details">
                        <span class="player-name" id="bottom-player-name">White</span>
                        <div id="bottom-material-diff" class="material-diff"></div>
                    </div>
                    <div class="material-bar-container">
                        <div id="bottom-material-bar" class="material-bar-fill"></div>
                    </div>
                    <div id="bottom-captured-pieces" class="captured-pieces"></div>
                    <span class="clock" id="bottom-player-clock">05:00</span>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <div class="panel controls-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Game Controls</h2>
                    <% if (user && user.role === 'admin') { %>
                        <a href="/admin" class="admin-link-btn" style="font-size: 12px; margin-left: auto;">Admin Panel</a>
                    <% } %>
                </div>
                <div class="panel-content">
                     <div id="status">Status: Disconnected</div>
                     <div class="button-group">
                        <button id="new-game-btn" data-i18n="new-game-btn">New Game</button>
                        <button id="new-960-btn">New Chess960</button>
                        <button id="resign-btn" style="background-color: #F2495C;">Resign</button>
                        <button id="offer-draw-btn">Offer Draw</button>
                        <button id="takeback-btn">Takeback</button>
                        <button id="force-move-btn">Force Move</button>
                        <button id="clear-analysis-btn">Clear Analysis</button>
                     </div>
                     <div class="button-group mt-10">
                        <button id="flip-board-btn" data-i18n="flip-board-btn">Flip Board</button>
                        <button id="self-play-btn">Self Play</button>
                        <button id="engine-duel-btn">Engine Duel</button>
                        <button id="tournament-btn">Tournament</button>
                        <button id="leaderboard-btn">Leaderboard</button>
                        <button id="armageddon-btn">Armageddon</button>
                     </div>
                     <div class="option-item mt-10">
                        <label>Time Control:</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="time-base" value="5" min="0" max="180" style="width: 50px;" title="Base Time (minutes)">
                            <span>+</span>
                            <input type="number" id="time-inc" value="0" min="0" max="60" style="width: 50px;" title="Increment (seconds)">
                        </div>
                     </div>
                     <div class="option-item">
                        <label for="game-mode">Game Mode:</label>
                        <select id="game-mode">
                            <option value="pve">Player vs Engine</option>
                            <option value="pvp">Player vs Player</option>
                            <option value="guess">Guess the Move</option>
                            <option value="vote">Vote Chess</option>
                        </select>
                     </div>
                     <div class="option-item">
                        <label for="handicap-select">Handicap:</label>
                        <select id="handicap-select">
                            <option value="none">None</option>
                            <option value="knight-b1">Knight Odds (b1)</option>
                            <option value="knight-g1">Knight Odds (g1)</option>
                            <option value="rook-a1">Rook Odds (a1)</option>
                            <option value="rook-h1">Rook Odds (h1)</option>
                            <option value="queen">Queen Odds</option>
                            <option value="pawn-f2">Pawn Odds (f2)</option>
                        </select>
                     </div>
                     <div class="option-item">
                        <label for="analysis-mode">Analysis Mode</label>
                        <input type="checkbox" id="analysis-mode">
                     </div>
                </div>
            </div>
            <div class="panel training-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Training</h2>
                </div>
                <div class="panel-content">
                    <div class="button-group">
                        <button id="memory-training-btn">Memory Training</button>
                        <button id="tactics-trainer-btn">Tactics Trainer</button>
                        <button id="endgame-trainer-btn">Endgame Trainer</button>
                        <button id="daily-puzzle-btn">Daily Puzzle</button>
                        <button id="repertoire-builder-btn">Opening Builder</button>
                        <button id="opening-explorer-btn">Opening Explorer</button>
                    </div>
                    <div id="repertoire-controls" style="display: none;" class="mt-10">
                        <div class="input-group">
                            <input type="text" id="repertoire-name" placeholder="Line Name (e.g. Najdorf)">
                            <button id="save-repertoire-btn">Save Line</button>
                        </div>
                        <div class="repertoire-list mt-10" id="repertoire-list">
                            <!-- Items -->
                        </div>
                    </div>
                    <div id="endgame-controls" style="display: none;" class="mt-10">
                        <label>Select Endgame:</label>
                        <select id="endgame-select">
                            <option value="kp-vs-k">King + Pawn vs King</option>
                            <option value="kq-vs-k">King + Queen vs King</option>
                            <option value="kr-vs-k">King + Rook vs King</option>
                            <option value="lucena">Lucena Position (Rook)</option>
                            <option value="philidor">Philidor Position (Rook)</option>
                        </select>
                        <button id="start-endgame-btn">Start Practice</button>
                    </div>
                    <div id="tactics-controls" style="display: none;" class="mt-10">
                        <div class="option-item">
                            <span id="tactics-desc">Find the best move!</span>
                        </div>
                        <button id="tactics-next-btn">Next Puzzle</button>
                    </div>
                    <div id="memory-training-controls" style="display: none;" class="mt-10">
                        <div class="option-item">
                            <span id="memory-timer">Time: 5</span>
                        </div>
                        <button id="memory-submit-btn">Check Result</button>
                        <button id="memory-give-up-btn">Give Up</button>
                    </div>
                    <div id="piece-palette" class="piece-palette" style="display: none;">
                        <!-- Pieces will be injected here -->
                    </div>
                </div>
            </div>
            <div class="panel chat-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Chat</h2>
                </div>
                <div class="panel-content">
                    <div id="chat-messages" style="height: 150px; overflow-y: auto; background: var(--grafana-input-bg); border: 1px solid var(--grafana-border); padding: 5px; margin-bottom: 5px; font-size: 13px;"></div>
                    <div class="input-group" style="margin-bottom: 0;">
                        <button id="emoji-trigger-btn" style="flex: 0 0 auto; width: 40px; padding: 0;">üòÄ</button>
                        <input type="text" id="chat-input" placeholder="Type a message...">
                        <button id="chat-send-btn" style="flex: 0 0 auto; width: 60px;">Send</button>
                    </div>
                    <div id="emoji-picker" style="display: none; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 5px; background: var(--grafana-input-bg); padding: 5px; border: 1px solid var(--grafana-border);">
                        <!-- Emojis will be injected -->
                    </div>
                </div>
            </div>
            <div class="panel opening-panel" id="opening-panel" style="display: none;">
                 <div class="panel-header">
                    <h2 class="panel-title">Opening Explorer</h2>
                    <button id="close-opening-panel-btn" class="icon-btn">&times;</button>
                </div>
                <div class="panel-content">
                    <div id="opening-name" style="font-weight: bold; margin-bottom: 5px;">-</div>
                    <div id="opening-eco" style="font-size: 12px; color: var(--grafana-text-secondary); margin-bottom: 10px;">-</div>
                    <table id="opening-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 1px solid var(--grafana-border);">
                                <th style="padding: 5px;">Move</th>
                                <th style="padding: 5px;">Weight</th>
                                <th style="padding: 5px;">%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="panel graphs-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Game Analysis Graphs</h2>
                </div>
                <div class="panel-content">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="material-chart">Material</button>
                        <button class="tab-btn" data-tab="time-chart">Time</button>
                        <button class="tab-btn" data-tab="nps-chart">NPS</button>
                        <button class="tab-btn" data-tab="tension-chart">Tension</button>
                    </div>
                    <div class="tab-content active" id="material-chart-tab">
                        <div class="graph-container large">
                            <svg id="material-graph" width="100%" height="100%"></svg>
                        </div>
                    </div>
                    <div class="tab-content" id="time-chart-tab">
                        <div class="graph-container large">
                            <svg id="time-graph" width="100%" height="100%"></svg>
                        </div>
                    </div>
                    <div class="tab-content" id="nps-chart-tab">
                         <div class="graph-container large">
                            <svg id="nps-graph" width="100%" height="100%"></svg>
                        </div>
                    </div>
                    <div class="tab-content" id="tension-chart-tab">
                         <div class="graph-container large">
                            <svg id="tension-graph" width="100%" height="100%"></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel import-export-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Import / Export</h2>
                </div>
                <div class="panel-content">
                    <div class="input-group">
                        <input type="text" id="fen-input" placeholder="Paste FEN here..." />
                        <button id="load-fen-btn">Load</button>
                    </div>
                    <div class="button-group mt-10">
                        <button id="copy-fen-btn">Copy FEN</button>
                        <button id="copy-fen-url-btn">Copy FEN URL</button>
                        <button id="download-board-btn" title="Download Screenshot">üì∑ Screenshot</button>
                        <button id="export-gif-btn" title="Export GIF">üéûÔ∏è GIF</button>
                        <button id="board-editor-btn">Board Editor</button>
                        <button id="import-pgn-btn">Import PGN</button>
                        <button id="export-pgn-btn">Export PGN</button>
                        <button id="copy-pgn-btn">Copy PGN</button>
                        <button id="download-pgn-btn">Download PGN</button>
                        <button id="pgn-settings-btn">PGN Settings</button>
                    </div>
                    <div class="separator"></div>
                    <div class="option-item">
                        <label>External Analysis:</label>
                        <div class="button-group">
                            <button id="analyze-lichess-btn" title="Analyze on Lichess">Lichess</button>
                            <button id="analyze-chesscom-btn" title="Analyze on Chess.com">Chess.com</button>
                        </div>
                    </div>
                    <div class="option-item">
                        <label>Share:</label>
                        <div class="button-group">
                            <button id="share-twitter-btn" style="background-color: #1DA1F2;">Twitter</button>
                            <button id="share-reddit-btn" style="background-color: #FF4500;">Reddit</button>
                            <button id="share-qr-btn" style="background-color: #444;" title="Share via QR Code">QR</button>
                            <button id="embed-btn" style="background-color: #555;" data-i18n="embed-btn">Embed</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel history-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Game History</h2>
                    <button id="replay-btn" class="icon-btn" title="Replay Game">‚ñ∂</button>
                </div>
                <div class="panel-content">
                    <div class="history-options" style="margin-bottom: 5px; display: flex; align-items: center; justify-content: space-between; gap: 5px;">
                         <div style="display: flex; gap: 5px;">
                             <input type="text" id="history-search-input" placeholder="Filter..." style="font-size: 12px; padding: 2px; width: 60px;">
                             <label title="Scroll Lock"><input type="checkbox" id="history-scroll-lock" checked></label>
                         </div>
                         <div style="display: flex; gap: 5px; align-items: center;">
                             <label for="history-notation-toggle" style="font-size: 12px; color: var(--grafana-text-secondary); margin-right: 5px;">Notation:</label>
                             <select id="history-notation-toggle" style="font-size: 12px; padding: 2px;">
                                 <option value="san">SAN (Nf3)</option>
                                 <option value="lan">LAN (g1f3)</option>
                             </select>
                         </div>
                    </div>
                    <div id="move-history" class="move-history-list"></div>
                    <div class="history-controls mt-10" style="display: flex; gap: 10px; align-items: center;">
                         <label for="replay-speed" style="color: var(--grafana-text-secondary); font-size: 14px;">Replay Speed:</label>
                         <input type="range" id="replay-speed" min="100" max="2000" step="100" value="800" style="flex: 1;">
                         <button id="analyze-game-btn" class="icon-btn" title="Analyze Game" style="font-size: 18px; margin-left: 10px;">üìä</button>
                    </div>
                </div>
            </div>
            <div class="panel board-settings-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Board Settings</h2>
                </div>
                <div class="panel-content">
                     <div class="option-item">
                        <label for="auto-flip">Auto-Flip Board:</label>
                        <input type="checkbox" id="auto-flip">
                     </div>
                     <div class="option-item">
                        <label for="auto-queen">Auto-Queen:</label>
                        <input type="checkbox" id="auto-queen">
                     </div>
                     <div class="option-item">
                        <label for="move-confirmation">Move Confirmation:</label>
                        <input type="checkbox" id="move-confirmation">
                     </div>
                     <div class="option-item">
                        <label for="zen-mode">Zen Mode:</label>
                        <input type="checkbox" id="zen-mode">
                     </div>
                     <div class="option-item">
                        <label for="blindfold-mode">Blindfold Mode:</label>
                        <input type="checkbox" id="blindfold-mode">
                     </div>
                     <div class="option-item">
                        <label for="blindfold-training">Disappearing Pieces:</label>
                        <input type="checkbox" id="blindfold-training">
                     </div>
                     <div class="option-item">
                         <button id="streamer-mode-btn">Streamer Mode</button>
                     </div>
                     <div class="option-item">
                        <label for="show-coords">Show Coordinates:</label>
                        <input type="checkbox" id="show-coords" checked>
                     </div>
                     <div class="option-item">
                        <label for="show-arrow-last">Last Move Arrow:</label>
                        <input type="checkbox" id="show-arrow-last">
                     </div>
                     <div class="option-item">
                        <label for="show-threats">Show Threats:</label>
                        <input type="checkbox" id="show-threats">
                     </div>
                     <div class="option-item">
                        <label for="coords-outside">Coordinates Outside:</label>
                        <input type="checkbox" id="coords-outside">
                     </div>
                     <div class="option-item">
                        <label for="mind-control-mode" title="Requires EEG Headset">Mind Control (Beta):</label>
                        <input type="checkbox" id="mind-control-mode">
                     </div>
                     <hr class="separator">
                     <div class="option-item">
                         <label style="font-weight: bold; color: var(--grafana-accent-blue);">Analysis Visuals:</label>
                     </div>
                     <div class="option-item">
                         <label for="viz-king-safety">King Safety Heatmap:</label>
                         <input type="checkbox" id="viz-king-safety">
                     </div>
                     <div class="option-item">
                         <label for="viz-mobility">Mobility Heatmap:</label>
                         <input type="checkbox" id="viz-mobility">
                     </div>
                     <div class="option-item">
                         <label for="viz-utilization">Square Utilization:</label>
                         <input type="checkbox" id="viz-utilization">
                     </div>
                     <div class="option-item">
                         <label for="viz-piece-tracker">Piece Tracker:</label>
                         <input type="checkbox" id="viz-piece-tracker">
                     </div>
                     <div class="option-item">
                         <label for="viz-outpost">Outposts:</label>
                         <input type="checkbox" id="viz-outpost">
                     </div>
                     <div class="option-item">
                         <label for="viz-weak-square">Weak Squares:</label>
                         <input type="checkbox" id="viz-weak-square">
                     </div>
                     <div class="option-item">
                         <label for="viz-battery">Battery:</label>
                         <input type="checkbox" id="viz-battery">
                     </div>
                     <div class="option-item">
                         <label for="viz-xray">X-Ray:</label>
                         <input type="checkbox" id="viz-xray">
                     </div>
                     <div class="option-item">
                         <label for="viz-pin">Pins:</label>
                         <input type="checkbox" id="viz-pin">
                     </div>
                     <div class="option-item">
                         <label for="viz-fork">Forks:</label>
                         <input type="checkbox" id="viz-fork">
                     </div>
                     <div class="option-item">
                         <label for="viz-discovered">Discovered Attacks:</label>
                         <input type="checkbox" id="viz-discovered">
                     </div>
                     <hr class="separator">
                     <div class="option-item">
                        <label for="ui-theme">UI Theme:</label>
                        <select id="ui-theme">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                     </div>
                     <div class="option-item">
                        <label for="language-select" data-i18n="language-label">Language:</label>
                        <select id="language-select">
                            <option value="en">English</option>
                            <option value="es">Espa√±ol</option>
                        </select>
                     </div>
                     <div class="option-item">
                        <label for="board-theme">Theme:</label>
                        <select id="board-theme">
                            <option value="classic">Classic</option>
                            <option value="green">Green</option>
                            <option value="blue">Blue</option>
                            <option value="wood">Wood</option>
                            <option value="glass">Glass</option>
                            <option value="newspaper">Newspaper</option>
                            <option value="custom">Custom</option>
                        </select>
                     </div>
                     <div id="custom-theme-controls" style="display: none;">
                         <div class="option-item">
                             <label for="custom-light-square">Light Square:</label>
                             <input type="color" id="custom-light-square" value="#E3E3E3">
                         </div>
                         <div class="option-item">
                             <label for="custom-dark-square">Dark Square:</label>
                             <input type="color" id="custom-dark-square" value="#6B6B6B">
                         </div>
                     </div>
                     <div class="option-item">
                         <label for="custom-css">Custom CSS:</label>
                         <textarea id="custom-css" rows="3" placeholder="Enter CSS here..."></textarea>
                     </div>
                     <div class="option-item">
                         <button id="apply-custom-css">Apply CSS</button>
                     </div>
                     <div class="option-item">
                        <label for="board-size">Max Width:</label>
                        <input type="range" id="board-size" min="200" max="1000" value="1000" step="10">
                     </div>
                     <div class="option-item">
                        <label for="piece-set">Piece Set:</label>
                        <select id="piece-set">
                            <option value="cburnett">Cburnett (Standard)</option>
                            <option value="alpha">Alpha</option>
                            <option value="merida">Merida</option>
                            <option value="3d">3D</option>
                            <option value="pixel">Pixel Art</option>
                            <option value="unicode">Unicode</option>
                        </select>
                     </div>
                     <div class="option-item">
                         <label for="animation-speed">Animation Speed:</label>
                         <select id="animation-speed">
                             <option value="0">Instant</option>
                             <option value="200" selected>Fast</option>
                             <option value="500">Normal</option>
                             <option value="1000">Slow</option>
                         </select>
                     </div>
                     <div class="option-item">
                         <label for="battery-saver" data-i18n="battery-saver-label">Battery Saver:</label>
                         <input type="checkbox" id="battery-saver">
                     </div>
                     <div class="option-item">
                         <label for="upload-theme-file">Upload Theme (JSON):</label>
                         <input type="file" id="upload-theme-file" accept=".json">
                     </div>
                     <div class="option-item">
                         <label for="upload-piece-set-files">Upload Piece Set:</label>
                         <input type="file" id="upload-piece-set-files" multiple accept="image/*">
                     </div>
                     <div class="option-item">
                         <label for="upload-user-avatar">User Avatar:</label>
                         <input type="file" id="upload-user-avatar" accept="image/*">
                     </div>
                     <div class="option-item">
                         <label for="upload-engine-avatar">Engine Avatar:</label>
                         <input type="file" id="upload-engine-avatar" accept="image/*">
                     </div>
                     <hr class="separator">
                     <div class="option-item">
                         <label style="font-weight: bold; color: var(--grafana-accent-blue);">Settings Management:</label>
                     </div>
                     <div class="button-group">
                         <button id="export-settings-btn">Export Settings</button>
                         <button id="import-settings-btn">Import Settings</button>
                         <button id="factory-reset-btn" style="background-color: #F2495C;">Factory Reset</button>
                     </div>
                     <input type="file" id="import-settings-file" accept=".json" style="display: none;">
                     <hr class="separator">
                     <div class="option-item">
                         <label style="font-weight: bold; color: var(--grafana-accent-blue);">Information:</label>
                     </div>
                     <div class="button-group">
                         <button id="changelog-btn">Changelog</button>
                         <button id="license-btn">License</button>
                         <button id="credits-btn">Credits</button>
                         <button id="shortcuts-btn">Shortcuts</button>
                         <button id="tutorial-btn">Tutorial</button>
                     </div>
                     <div class="button-group mt-10">
                         <button id="install-app-btn" style="display: none; background-color: var(--grafana-accent-blue);">Install App</button>
                         <button id="sponsor-btn" style="background-color: #ea4aaa;">Sponsor</button>
                         <button id="feedback-btn">Feedback</button>
                     </div>
                </div>
            </div>
            <div class="panel uci-options-panel">
                 <div class="panel-header">
                    <h2 class="panel-title">Engine Options</h2>
                    <button id="reset-engine-btn" class="icon-btn" title="Reset Engine" data-i18n-title="reset-engine-btn">‚Üª</button>
                </div>
                <div class="panel-content">
                    <div class="option-item engine-upload-section">
                        <label class="engine-upload-label">Local Engine (.js/.wasm):</label>
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <input type="file" id="local-engine-file" accept=".js,.wasm">
                        </div>
                        <div style="display: flex; align-items: center; margin-top: 5px;">
                            <label for="use-local-engine">Use Local Engine</label>
                            <input type="checkbox" id="use-local-engine" disabled>
                        </div>
                    </div>
                    <div class="option-item engine-upload-section">
                        <label class="engine-upload-label">Cloud Engine (WebSocket):</label>
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <input type="text" id="cloud-engine-url" placeholder="ws://localhost:8080" style="flex: 1;">
                            <button id="connect-cloud-btn" style="width: auto; padding: 5px 10px;">Connect</button>
                        </div>
                        <div style="display: flex; align-items: center; margin-top: 5px;">
                            <label for="use-cloud-engine">Use Cloud Engine</label>
                            <input type="checkbox" id="use-cloud-engine" disabled>
                        </div>
                    </div>
                    <div class="option-item">
                        <label>Presets:</label>
                        <select id="uci-preset-select">
                            <option value="">-- Select --</option>
                            <option value="blitz">Blitz</option>
                            <option value="analysis">Analysis</option>
                            <option value="stock">Defaults</option>
                        </select>
                    </div>
                    <div id="uci-options">
                        <!-- UCI options will be generated here -->
                    </div>
                </div>
            </div>
            <div class="panel search-stats-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Search Visualization</h2>
                    <button id="show-tree-btn" class="icon-btn" title="Variation Tree">üå≤</button>
                </div>
                <div class="panel-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Eval</div>
                            <div class="stat-value" id="eval-value">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Depth</div>
                            <div class="stat-value" id="depth-value">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">NPS</div>
                            <div class="stat-value" id="nps-value">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">WDL</div>
                            <div class="stat-value" id="wdl-value">-</div>
                        </div>
                    </div>
                    <div class="graph-container">
                         <svg id="eval-graph" width="100%" height="100%" style="display: block;"></svg>
                    </div>
                    <div class="pv-container">
                        <div class="pv-label">Principal Variation</div>
                        <div class="pv-lines" id="pv-lines"></div>
                    </div>
                </div>
            </div>
            <div class="panel engine-output-panel">
                 <div class="panel-header">
                    <h2 class="panel-title">Engine Output</h2>
                </div>
                <div class="panel-content">
                    <div id="engine-output"></div>
                </div>
            </div>
            <div class="panel developer-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Developer Tools</h2>
                </div>
                <div class="panel-content">
                    <div class="button-group">
                        <button id="perft-btn" title="Run Perft(5)">Perft Bench</button>
                        <button id="sanity-check-btn" title="Verify Board State">Sanity Check</button>
                        <button id="zobrist-btn" title="Get Zobrist Key">Get Zobrist</button>
                        <button id="force-gc-btn" title="Force Garbage Collection">Force GC</button>
                        <button id="null-move-btn" title="Make Null Move">Null Move</button>
                    </div>
                    <div class="separator"></div>
                    <div class="stat-grid-compact">
                        <div class="stat-item">
                            <label>Mem:</label>
                            <span id="dev-memory-usage">-</span>
                        </div>
                        <div class="stat-item">
                            <label>Ping:</label>
                            <span id="dev-latency">-</span>
                        </div>
                        <div class="stat-item">
                            <label>Threads:</label>
                            <span id="dev-threads">-</span>
                        </div>
                    </div>
                     <div class="option-item">
                         <label>Hash Usage:</label>
                         <div class="progress-bar-container">
                             <div id="dev-hash-bar" class="progress-bar-fill" style="width: 0%;"></div>
                         </div>
                     </div>
                     <div class="option-item">
                         <label>Search Depth:</label>
                         <div class="progress-bar-container">
                             <div id="dev-depth-bar" class="progress-bar-fill" style="width: 0%;"></div>
                         </div>
                     </div>
                    <div class="separator"></div>
                    <div class="option-item">
                        <label for="dev-debug-overlay">Debug Overlay:</label>
                        <input type="checkbox" id="dev-debug-overlay">
                    </div>
                    <div class="option-item">
                        <label for="dev-packet-inspector">Packet Inspector:</label>
                        <input type="checkbox" id="dev-packet-inspector">
                    </div>
                    <div id="packet-inspector-container" style="display: none; margin-top: 10px;">
                        <div id="packet-log" class="console-log"></div>
                    </div>
                </div>
            </div>
            <div class="panel system-log-panel">
                <div class="panel-header">
                   <h2 class="panel-title">System Log</h2>
                   <button id="export-log-btn" class="icon-btn" title="Export Log">üíæ</button>
               </div>
               <div class="panel-content">
                   <div id="system-log"></div>
               </div>
           </div>
            <div class="panel tournament-panel" id="tournament-panel" style="display: none;">
                <div class="panel-header">
                   <h2 class="panel-title">Tournament Standings</h2>
               </div>
               <div class="panel-content">
                   <table id="tournament-standings-table">
                       <thead>
                           <tr>
                               <th>Rank</th>
                               <th>Engine</th>
                               <th>Elo</th>
                               <th>Score</th>
                               <th>Games</th>
                           </tr>
                       </thead>
                       <tbody></tbody>
                   </table>
                   <div class="tournament-match-list" id="tournament-match-queue"></div>
                   <div class="button-group mt-10">
                       <button id="stop-tournament-btn" style="background-color: #F2495C;">Stop Tournament</button>
                   </div>
               </div>
           </div>
        </div>
    </main>
  </div>
  <button id="accessibility-btn" class="icon-btn" title="Accessibility Options">‚ôø</button>
  <div id="accessibility-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Accessibility & Sound</h3>
              <button class="modal-close-btn" id="close-accessibility-modal">&times;</button>
          </div>
          <div class="modal-content">
               <div class="option-item">
                  <label for="sound-enabled">Enable Sound:</label>
                  <input type="checkbox" id="sound-enabled">
               </div>
               <div class="option-item">
                   <label for="volume-control">Volume:</label>
                   <input type="range" id="volume-control" min="0" max="1" step="0.1" value="1.0">
               </div>
               <div class="option-item">
                  <label for="voice-announce">Voice Announcements:</label>
                  <input type="checkbox" id="voice-announce">
               </div>
               <div class="option-item">
                  <label for="voice-control">Voice Control:</label>
                  <input type="checkbox" id="voice-control">
               </div>
               <div class="option-item">
                  <label for="high-contrast">High Contrast Mode:</label>
                  <input type="checkbox" id="high-contrast">
               </div>
               <div class="option-item">
                   <label for="sound-pack-upload">Upload Sound Pack (ZIP):</label>
                   <input type="file" id="sound-pack-upload" accept=".zip">
               </div>
          </div>
      </div>
  </div>
  <div id="tournament-setup-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Tournament Setup</h3>
              <button class="modal-close-btn" id="close-tournament-modal">&times;</button>
          </div>
          <div class="modal-content">
              <div class="option-item">
                  <label>Type:</label>
                  <select id="tournament-type">
                      <option value="round-robin">Round Robin</option>
                  </select>
              </div>
              <div class="option-item">
                  <label>Rounds:</label>
                  <input type="number" id="tournament-rounds" value="1" min="1" max="10">
              </div>
              <div class="separator"></div>
              <h4>Players (Engines)</h4>
              <div id="tournament-players-list" class="tournament-setup-list">
                  <!-- Dynamic Inputs -->
              </div>
              <button id="add-tournament-player-btn" style="background-color: var(--grafana-panel-bg); border: 1px dashed var(--grafana-text-secondary); color: var(--grafana-text-secondary);">+ Add Player</button>
          </div>
          <div class="modal-footer">
              <button id="start-tournament-confirm-btn">Start Tournament</button>
          </div>
      </div>
  </div>
  <div id="qr-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Share Game</h3>
              <button class="modal-close-btn" id="close-qr-modal">&times;</button>
          </div>
          <div class="modal-content" style="text-align: center;">
              <div id="qrcode-container" style="display: inline-block; padding: 10px; background: white;"></div>
              <p style="margin-top: 10px; font-size: 12px; color: var(--grafana-text-secondary);">Scan to open this game on mobile.</p>
          </div>
      </div>
  </div>
  <div id="game-over-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Game Over</h3>
              <button class="modal-close-btn" id="close-game-over-modal">&times;</button>
          </div>
          <div class="modal-content" style="text-align: center;">
              <h2 id="game-over-result" style="margin: 10px 0;">-</h2>
              <p id="game-over-reason" style="color: var(--grafana-text-secondary); margin-bottom: 20px;">-</p>
              <div class="button-group" style="justify-content: center;">
                  <button id="game-over-new-game-btn">New Game</button>
                  <button id="game-over-analyze-btn">Analyze</button>
              </div>
          </div>
      </div>
  </div>
  <div id="leaderboard-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Engine Leaderboard</h3>
              <button class="modal-close-btn" id="close-leaderboard-modal">&times;</button>
          </div>
          <div class="modal-content">
              <table id="leaderboard-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                  <thead>
                      <tr style="text-align: left; border-bottom: 1px solid var(--grafana-border);">
                          <th style="padding: 5px;">Engine</th>
                          <th style="padding: 5px;">Games</th>
                          <th style="padding: 5px;">W</th>
                          <th style="padding: 5px;">D</th>
                          <th style="padding: 5px;">L</th>
                          <th style="padding: 5px;">Score %</th>
                      </tr>
                  </thead>
                  <tbody></tbody>
              </table>
              <div style="margin-top: 10px; text-align: right;">
                  <button id="reset-leaderboard-btn" style="background-color: #F2495C; padding: 5px 10px; font-size: 12px;">Reset Data</button>
              </div>
          </div>
      </div>
  </div>
  <div id="analysis-report-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Game Analysis Report</h3>
              <div style="display: flex; gap: 5px;">
                  <button id="export-analysis-btn" class="icon-btn" title="Export JSON">üíæ</button>
                  <button id="import-analysis-btn" class="icon-btn" title="Import JSON">üìÇ</button>
                  <input type="file" id="import-analysis-file" accept=".json" style="display: none;">
                  <button class="modal-close-btn" id="close-analysis-modal">&times;</button>
              </div>
          </div>
          <div class="modal-content">
              <div id="analysis-progress-bar" style="width: 100%; height: 5px; background: #333; margin-bottom: 10px; display: none;">
                  <div id="analysis-progress-fill" style="width: 0%; height: 100%; background: var(--grafana-accent-blue);"></div>
              </div>
              <div id="analysis-summary" style="margin-bottom: 20px;"></div>
              <table id="analysis-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                      <tr style="text-align: left; border-bottom: 1px solid var(--grafana-border);">
                          <th style="padding: 5px;">Move</th>
                          <th style="padding: 5px;">Played</th>
                          <th style="padding: 5px;">Best</th>
                          <th style="padding: 5px;">Diff</th>
                          <th style="padding: 5px;">Eval</th>
                      </tr>
                  </thead>
                  <tbody></tbody>
              </table>
          </div>
      </div>
  </div>
  <div id="pgn-import-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Import PGN</h3>
              <button class="modal-close-btn" id="close-pgn-modal">&times;</button>
          </div>
          <div class="modal-content">
              <textarea id="pgn-input-area" rows="10" style="width: 100%; background: var(--grafana-input-bg); color: var(--grafana-text-primary); border: 1px solid var(--grafana-border); border-radius: 4px; padding: 10px;" placeholder="Paste PGN here..."></textarea>
          </div>
          <div class="modal-footer">
              <button id="load-pgn-confirm-btn">Load PGN</button>
          </div>
      </div>
  </div>
  <div id="pgn-settings-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">PGN Header Settings</h3>
              <button class="modal-close-btn" id="close-pgn-settings-modal">&times;</button>
          </div>
          <div class="modal-content">
              <div class="option-item">
                  <label for="pgn-white">White:</label>
                  <input type="text" id="pgn-white" value="White">
              </div>
              <div class="option-item">
                  <label for="pgn-black">Black:</label>
                  <input type="text" id="pgn-black" value="Black">
              </div>
              <div class="option-item">
                  <label for="pgn-event">Event:</label>
                  <input type="text" id="pgn-event" value="Casual Game">
              </div>
          </div>
          <div class="modal-footer">
              <button id="save-pgn-settings-btn">Save</button>
          </div>
      </div>
  </div>
  <div id="duel-setup-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Engine Duel Setup</h3>
              <button class="modal-close-btn" id="close-duel-modal">&times;</button>
          </div>
          <div class="modal-content">
              <div class="engine-config-section">
                  <h4 class="engine-config-title">Engine A (White)</h4>
                  <div class="option-item">
                      <label for="engine-a-name">Name:</label>
                      <input type="text" id="engine-a-name" value="Engine A">
                  </div>
                  <div class="option-item">
                      <label for="engine-a-elo">UCI_Elo (Rating):</label>
                      <input type="number" id="engine-a-elo" value="1500" min="100" max="4000">
                  </div>
                  <div class="option-item">
                    <label for="engine-a-limit">Limit Strength:</label>
                    <input type="checkbox" id="engine-a-limit" checked>
                </div>
              </div>
              <div class="engine-config-section">
                  <h4 class="engine-config-title">Engine B (Black)</h4>
                  <div class="option-item">
                      <label for="engine-b-name">Name:</label>
                      <input type="text" id="engine-b-name" value="Engine B">
                  </div>
                  <div class="option-item">
                      <label for="engine-b-elo">UCI_Elo (Rating):</label>
                      <input type="number" id="engine-b-elo" value="2000" min="100" max="4000">
                  </div>
                  <div class="option-item">
                    <label for="engine-b-limit">Limit Strength:</label>
                    <input type="checkbox" id="engine-b-limit" checked>
                </div>
              </div>
          </div>
          <div class="modal-footer">
              <button id="start-duel-btn">Start Duel</button>
          </div>
      </div>
  </div>
  <div id="promotion-modal" class="modal-overlay">
      <div class="modal promotion-modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Promote to:</h3>
          </div>
          <div class="modal-content">
              <div class="promotion-options">
                  <div class="promo-piece" data-piece="q"><img src="" alt="Queen"></div>
                  <div class="promo-piece" data-piece="r"><img src="" alt="Rook"></div>
                  <div class="promo-piece" data-piece="b"><img src="" alt="Bishop"></div>
                  <div class="promo-piece" data-piece="n"><img src="" alt="Knight"></div>
              </div>
          </div>
      </div>
  </div>
  <div id="tree-modal" class="modal-overlay">
      <div class="modal large-modal" style="width: 90%; height: 90%;">
          <div class="modal-header">
              <h3 class="modal-title">Variation Tree</h3>
              <button class="modal-close-btn" id="close-tree-modal">&times;</button>
          </div>
          <div class="modal-content" style="overflow: auto; background: white; padding: 0;">
              <div id="d3-tree-container" style="width: 100%; height: 100%;"></div>
          </div>
      </div>
  </div>
  <div id="board-editor-modal" class="modal-overlay">
      <div class="modal large-modal">
          <div class="modal-header">
              <h3 class="modal-title">Board Editor</h3>
              <button class="modal-close-btn" id="close-board-editor-modal">&times;</button>
          </div>
          <div class="modal-content board-editor-content">
              <div class="editor-main">
                  <div id="editor-board-container" class="editor-board"></div>
                  <div class="editor-palette">
                      <div class="palette-row" id="palette-w"></div>
                      <div class="palette-row" id="palette-b"></div>
                      <div class="palette-tools">
                          <button id="editor-trash-btn" class="icon-btn" title="Trash Mode">üóëÔ∏è</button>
                          <button id="editor-clear-btn">Clear Board</button>
                          <button id="editor-startpos-btn">Start Pos</button>
                      </div>
                  </div>
              </div>
              <div class="editor-sidebar">
                  <div class="option-item">
                      <label>Side to Move:</label>
                      <div class="radio-group">
                          <label><input type="radio" name="editor-turn" value="w" checked> White</label>
                          <label><input type="radio" name="editor-turn" value="b"> Black</label>
                      </div>
                  </div>
                  <div class="option-item">
                      <label>Castling Rights:</label>
                      <div class="checkbox-group">
                          <label><input type="checkbox" id="editor-castling-wk"> White King-side (K)</label>
                          <label><input type="checkbox" id="editor-castling-wq"> White Queen-side (Q)</label>
                          <label><input type="checkbox" id="editor-castling-bk"> Black King-side (k)</label>
                          <label><input type="checkbox" id="editor-castling-bq"> Black Queen-side (q)</label>
                      </div>
                  </div>
                  <div class="option-item">
                      <label>En Passant Target:</label>
                      <input type="text" id="editor-ep-target" placeholder="e.g. e3" maxlength="2">
                  </div>
                  <div class="option-item">
                      <label>Fullmove Number:</label>
                      <input type="number" id="editor-fullmove" value="1" min="1">
                  </div>
                  <div class="option-item">
                      <label>Halfmove Clock:</label>
                      <input type="number" id="editor-halfmove" value="0" min="0">
                  </div>
                  <div class="option-item">
                      <label>FEN:</label>
                      <input type="text" id="editor-fen-output" readonly>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
              <button id="load-position-btn">Load Position</button>
          </div>
      </div>
  </div>
  <script src="libs/chess.js"></script>
  <script src="libs/gif.js"></script>
  <script src="libs/qrcode.min.js"></script>
  <script src="libs/jszip.min.js"></script>
  <script src="libs/d3.min.js"></script>
  <script src="js/ClientUtils.js"></script>
  <script src="js/SoundManager.js"></script>
  <script src="js/AccessibilityManager.js"></script>
  <script src="js/ArrowManager.js"></script>
  <script src="js/VisualizationManager.js"></script>
  <script src="js/GraphManager.js"></script>
  <script src="js/SocketHandler.js"></script>
  <script src="js/BoardRenderer.js"></script>
  <script src="js/BoardInfoRenderer.js"></script>
  <script src="js/GameManager.js"></script>
  <script src="js/AnalysisManager.js"></script>
  <script src="js/TrainingManager.js"></script>
  <script src="js/UIOptionFactory.js"></script>
  <script src="js/UIConstants.js"></script>
  <script src="js/UIManager.js"></script>
  <script src="js/MoveHandler.js"></script>
  <script src="js/BoardEditor.js"></script>
  <script src="js/LeaderboardManager.js"></script>
  <script src="js/PgnManager.js"></script>
  <script src="js/FenManager.js"></script>
  <script src="js/DeveloperManager.js"></script>
  <script src="js/MoveListManager.js"></script>
  <script src="js/OpeningExplorer.js"></script>
  <script src="js/TreeManager.js"></script>
  <script src="js/SettingsManager.js"></script>
  <script src="js/ExternalActions.js"></script>
  <script src="js/AutoSaveManager.js"></script>
  <script src="js/InfoManager.js"></script>
  <script src="js/VisualEffects.js"></script>
  <script src="js/BatterySaver.js"></script>
  <script src="js/ChatManager.js"></script>
  <script src="js/TutorialManager.js"></script>
  <script src="js/LanguageManager.js"></script>
  <script src="js/LocalEngineManager.js"></script>
  <script src="js/CloudEngineManager.js"></script>
  <script src="js/EngineProxy.js"></script>
  <script src="tournament.js"></script>
  <script src="libs/simplewebauthn-browser.min.js"></script>
  <script src="js/AuthManager.js"></script>
  <script src="client.js"></script>
  <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none;"></canvas>
  <div id="toast-container"></div>
  <div id="move-context-menu" class="context-menu" style="display: none;">
    <div class="menu-item" data-action="comment">Add Comment</div>
    <div class="menu-item" data-action="nag">Add NAG</div>
    <div class="menu-item" data-action="delete-rest" style="color: #F2495C;">Delete Remaining</div>
  </div>
  <div id="nag-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title">Select NAG</h3>
              <button class="modal-close-btn" id="close-nag-modal">&times;</button>
          </div>
          <div class="modal-content">
              <div class="nag-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;">
                  <!-- Injected via JS -->
              </div>
          </div>
      </div>
  </div>
  <div id="info-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title" id="info-modal-title">Info</h3>
              <button class="modal-close-btn" id="close-info-modal">&times;</button>
          </div>
          <div class="modal-content" id="info-modal-content" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; font-size: 13px;">
          </div>
      </div>
  </div>
  <div id="embed-modal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <h3 class="modal-title" data-i18n="embed-btn">Embed</h3>
              <button class="modal-close-btn" id="close-embed-modal">&times;</button>
          </div>
          <div class="modal-content">
              <p>Copy this code to embed the game in your website:</p>
              <textarea id="embed-code-area" style="width: 100%; height: 100px; margin-top: 10px; font-family: monospace;"></textarea>
              <button id="copy-embed-btn" style="margin-top: 10px;">Copy to Clipboard</button>
          </div>
      </div>
  </div>
  <div id="offline-badge" class="offline-badge" style="display: none;" data-i18n="offline-badge">Offline</div>
  <div id="version-display" style="position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #555; opacity: 0.5;"></div>
</body>
</html>
